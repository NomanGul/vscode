steps:
- task: NodeTool@0
  displayName: Use Node 8.11.3
  inputs:
    versionSpec: 8.11.3

- task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@2
  inputs:
    versionSpec: "1.3.2"

- script: |
    set -e
    cd build && yarn
  displayName: Compile build scripts

- task: Npm@1
  displayName: npm install
  inputs:
    workingDir: remote
    verbose: false

- task: CopyFiles@2
  displayName: Copy Node Executable
  inputs:
    SourceFolder: '/opt/hostedtoolcache/node/8.11.3/x64/bin'
    Contents: 'node'
    TargetFolder: '$(Build.ArtifactStagingDirectory)/VSCode-wsl-x64'

- task: CopyFiles@2
  displayName: Copy Node Modules
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)/remote'
    Contents: 'node_modules/**'
    TargetFolder: '$(Build.ArtifactStagingDirectory)/VSCode-wsl-x64'

- task: ArchiveFiles@2
  displayName: Archive Package
  inputs:
    rootFolderOrFile: '$(Build.ArtifactStagingDirectory)/VSCode-wsl-x64'
    includeRootFolder: false
    archiveType: tar
    archiveFile: '$(Build.ArtifactStagingDirectory)/VSCode-wsl-x64.tar.gz'

- script: |
    set -e
    AZURE_STORAGE_ACCESS_KEY_2="$(AZURE_STORAGE_ACCESS_KEY_2)" \
    node build/tfs/wsl/wsl.js --commit $BUILD_SOURCEVERSION --upload "$BUILD_ARTIFACTSTAGINGDIRECTORY/VSCode-wsl-x64.tar.gz"
